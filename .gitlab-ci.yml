image: docker:stable
services:
# we will build our images by running docker daemon inside a container
- docker:dind
variables:
  DOCKER_DRIVER: overlay2
  SERVER_DOCKER_IMAGE: popovmi/tictactoe-server

stages:
- build
- deploy

build_server:
  stage: build
  script:
  - docker build -f ./Dockerfile -t $SERVER_DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA .
  - docker tag $SERVER_DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA $SERVER_DOCKER_IMAGE:latest

deploy_server:
  stage: deploy
  before_script: 
  - ./kuber/define_env.sh $CI_COMMIT_BRANCH
  environment: $CI_ENVIRONMENT
  script:
  - ./kuber/deploy_server.sh $CI_COMMIT_BRANCH